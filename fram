#!/bin/bash
# Board FRAM - Board Farm Remote Access Management

set -e

PATH="$HOME/bin:/usr/bin:/bin"

BOARD=$USER
USER=$1

# Log access early
echo "$(date +'%F %T') $BOARD $USER $SSH_ORIGINAL_COMMAND" >> fram.log

function usage()
{
	# User commands help
	cat <<END

Board FRAM - The Board Farm Remote Access Manager

Valid commands are:

    help                           This usage information
END
	type "acc-$BOARD-on" >& /dev/null && cat <<END
    acc [on|off|status*]           Control board accessory switch
END
	if type "power-$BOARD-sample" >& /dev/null; then
		sample="|sample"
	else
		filler="       "
	fi
	cat <<END
    console                        Access the board console (use "ssh -t")
    ls                             List the TFTP directory contents
    power [on|off$sample|status*]$filler  Control board power
    reset                          Reset board
    rsync                          Upload files to TFTP directory (use rsync)
    status                         Show board status
END
	type "wake-$BOARD" >& /dev/null && cat <<END
    wake                           Wake board by key
END

	type "wol-$BOARD" >& /dev/null && cat <<END
    wol                            Wake board through Wake-on-LAN
END

	cat <<END

Options marked with an asterisk are the default
END

	# Admin commands help
	test "$ADMIN" == "true" && cat <<END

Valid admin commands are:

    logs                    View and monitor the logs
    shell                   Launch a shell (use "ssh -t")

END

	# Show board-specific information, if available
	test -f "$BOARD.txt" && cat "$BOARD.txt"

	exit 0
}

# Load board-specific definitions, if available
test -f "$BOARD.cfg" && source "$BOARD.cfg"

# Initialise defaults
TFTP_ROOT=${TFTP_ROOT:-/var/lib/tftpboot}

# Admin commands must be enabled explicitly by setting ADMIN_USERS
if [ "$ADMIN_USERS" != "" ]; then
	ADMIN=$(eval "case $USER in $ADMIN_USERS) echo true ;; esac")
fi

# Handle help and welcome early, as they do not need locking
case "$SSH_ORIGINAL_COMMAND" in
	help)
		usage
		;;

	"")
		# Welcome banner
		if [ "$ADMIN" == "true" ]; then
			echo "Welcome master $USER, your wish is my command"
		else
			echo "Welcome $USER"
		fi
		exit 0
esac

# Admin commands
if [ "$ADMIN" == "true" ]; then
	case "$SSH_ORIGINAL_COMMAND" in
	logs)
		exec tail -f fram.log
		;;
	shell)
		exec /bin/bash -l
		;;
	esac
fi

# FIXME board locking/reservation

# User commands
case "$SSH_ORIGINAL_COMMAND" in
	acc*)
		# Optional
		if type "acc-$BOARD-on" >& /dev/null; then
			case "$SSH_ORIGINAL_COMMAND" in
			acc\ on|acc\ 1)
				"acc-$BOARD-on"
				exit 0
				;;

			acc\ off|acc\ 0)
				"acc-$BOARD-off"
				exit 0
				;;

			acc\ status|acc)
				"acc-$BOARD-status"
				exit 0
				;;
			esac
		fi
		;;& # fallthrough

	console)
		"screen-$BOARD"
		exit 0
		;;

	ls)
		exec ls -lAh "$TFTP_ROOT/$BOARD"
		;;

	power*)
		case "$SSH_ORIGINAL_COMMAND" in
		power\ on|power\ 1)
			"power-$BOARD-on"
			exit 0
			;;

		power\ off|power\ 0)
			"power-$BOARD-off"
			exit 0
			;;

		power\ sample)
			# Optional
			type "power-$BOARD-sample" >& /dev/null && { "power-$BOARD-sample"; exit 0; }
			;;

		power\ status|power)
			"power-$BOARD-status"
			exit 0
			;;
		esac
		;;& # fallthrough

	reset)
		"reset-$BOARD"
		exit 0
		;;

	rsync\ *)
		export SSH_ORIGINAL_COMMAND
		exec /usr/bin/rrsync -wo "$TFTP_ROOT/$BOARD"
		;;

	status)
		# Show board status
		power=$("power-$BOARD-status")
		if [ "$power" == "1" ]; then
			power=on
		else
			power=off
		fi
		status="power: $power"

		# Optional
		if type "acc-$BOARD-status" >& /dev/null; then
			acc=$("acc-$BOARD-status")
			if [ "$acc" == "1" ]; then
				acc=on
			else
				acc=off
			fi
			status="$status / acc: $acc"
		fi
		echo "$status"
		exit 0
		;;

	wake)
		# Optional
		type "wake-$BOARD" >& /dev/null && { "wake-$BOARD"; exit 0; }
		;;& # fallthrough

	wol)
		# Optional
		type "wol-$BOARD" >& /dev/null && { "wol-$BOARD"; exit 0; }
		;;& # fallthrough

	*)
		echo "Unknown command $SSH_ORIGINAL_COMMAND"
		usage
		;;
esac
